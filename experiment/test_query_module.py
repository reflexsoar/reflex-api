from rql.parser import QueryParser
from ply.lex import LexError

if __name__ == "__main__":

    db = [
      #{'uuid': '6e3cf4c1-c45c-45ab-8a66-fc9ff6aad5f1', 'title': 'Suspicious DNS Query', 'reference': 'QpKl83wBZ5pJo3SvcNpe', 'description': 'A computer has made a DNS query to a suspicious domain', 'tlp': 0, 'severity': 0, 'status': 'New', 'source': '.siem-signals', 'tags': ['Command & Control'], 'observables': [{'tags': ['destination-ip'], 'value': '34.203.97.10', 'ioc': None, 'tlp': 3, 'spotted': None, 'safe': None, 'data_type': 'ip', 'uuid': 'cb7051cc-94c7-470a-8018-8c3173fcd06e', 'case': None, 'source_field': 'destination_ip', 'original_source_field': 'dns.resolved_ip'}, {'tags': ['destination-ip'], 'value': '54.163.235.119', 'ioc': None, 'tlp': 3, 'spotted': None, 'safe': None, 'data_type': 'ip', 'uuid': 'f72b2eae-0696-4f49-96ca-c3d3c96fa066', 'case': None, 'source_field': 'destination_ip', 'original_source_field': 'dns.resolved_ip'}, {'tags': ['destination-ip'], 'value': '54.147.59.169', 'ioc': None, 'tlp': 3, 'spotted': None, 'safe': None, 'data_type': 'ip', 'uuid': 'a5fc133d-594d-429c-ab13-0816f5b4a510', 'case': None, 'source_field': 'destination_ip', 'original_source_field': 'dns.resolved_ip'}, {'tags': ['destination-ip'], 'value': '34.231.24.224', 'ioc': None, 'tlp': 3, 'spotted': None, 'safe': None, 'data_type': 'ip', 'uuid': 'a4d6e5db-f999-41c6-8a84-75a654204cda', 'case': None, 'source_field': 'destination_ip', 'original_source_field': 'dns.resolved_ip'}, {'tags': ['destination-ip'], 'value': '34.193.255.5', 'ioc': None, 'tlp': 3, 'spotted': None, 'safe': None, 'data_type': 'ip', 'uuid': '9fdabcdc-32c4-47e8-af2e-a6e87f0e0f30', 'case': None, 'source_field': 'destination_ip', 'original_source_field': 'dns.resolved_ip'}, {'tags': ['destination-ip'], 'value': '34.225.62.185', 'ioc': None, 'tlp': 3, 'spotted': None, 'safe': None, 'data_type': 'ip', 'uuid': 'e1f2902e-f3f0-4e8c-b577-7689e75015ea', 'case': None, 'source_field': 'destination_ip', 'original_source_field': 'dns.resolved_ip'}, {'tags': ['destination-ip'], 'value': '54.92.199.186', 'ioc': None, 'tlp': 3, 'spotted': None, 'safe': None, 'data_type': 'ip', 'uuid': 'e0b9fcba-1d35-4708-b1d7-e0684ee12d77', 'case': None, 'source_field': 'destination_ip', 'original_source_field': 'dns.resolved_ip'}, {'tags': ['destination-domain'], 'value': 'netwars-support.slack.com', 'ioc': None, 'tlp': 3, 'spotted': None, 'safe': None, 'data_type': 'domain', 'uuid': '541143d3-1ea2-4e37-b6a9-a32375b6ce1c', 'case': None, 'source_field': 'dns.question.name', 'original_source_field': 'dns.question.name'}, {'tags': ['workstation'], 'value': 'BRIAN-PC', 'ioc': None, 'tlp': 3, 'spotted': None, 'safe': None, 'data_type': 'host', 'uuid': '75bddb48-310e-4cc1-9245-980b7c5a8d53', 'case': None, 'source_field': 'host.name', 'original_source_field': 'host.name'}, {'tags': ['source-user'], 'value': 'BRIAN-PC\\Brian', 'ioc': None, 'tlp': 3, 'spotted': None, 'safe': None, 'data_type': 'user', 'uuid': 'd24c2402-79e2-4bb5-a32f-1b25d2818c90', 'case': None, 'source_field': 'winlog.event_data.User', 'original_source_field': 'winlog.event_data.User'}, {'tags': ['destination-ip'], 'value': '34.204.109.226', 'ioc': None, 'tlp': 3, 'spotted': None, 'safe': None, 'data_type': 'ip', 'uuid': 'bb0e24a5-be12-4ae3-81ae-2eed4ad9ac33', 'case': None, 'source_field': 'destination_ip', 'original_source_field': 'dns.resolved_ip'}, {'tags': ['destination-ip'], 'value': '3.95.117.96', 'ioc': None, 'tlp': 3, 'spotted': None, 'safe': None, 'data_type': 'ip', 'uuid': '15b6ac84-679b-4272-94b2-29cbe7c02959', 'case': None, 'source_field': 'destination_ip', 'original_source_field': 'dns.resolved_ip'}], 'case': None, 'created_at': '2021-11-06T05:15:52.338122Z', 'modified_at': '2021-11-06T05:15:53.273723Z', 'raw_log': '{"@timestamp": "2021-11-06T05:11:14.418Z", "sysmon": {"dns": {"status": "SUCCESS"}}, "log": {"level": "information"}, "message": "Dns query:\\nRuleName: -\\nUtcTime: 2021-11-06 05:07:54.376\\nProcessGuid: {f0ea5239-a5c8-617c-9c01-000000006d00}\\nProcessId: 2400\\nQueryName: netwars-support.slack.com\\nQueryStatus: 0\\nQueryResults: 34.204.109.226;3.95.117.96;34.203.97.10;54.163.235.119;54.147.59.169;34.231.24.224;34.193.255.5;34.225.62.185;54.92.199.186;\\nImage: C:\\\\Users\\\\Brian\\\\AppData\\\\Local\\\\slack\\\\app-4.20.0\\\\slack.exe\\nUser: BRIAN-PC\\\\Brian", "host": {"hostname": "BRIAN-PC", "architecture": "x86_64", "os": {"kernel": "10.0.19041.1288 (WinBuild.160101.0800)", "build": "19043.1288", "type": "windows", "platform": "windows", "version": "10.0", "family": "windows", "name": "Windows 10 Pro"}, "id": "f0ea5239-c22b-4596-bf23-1a94c654eabb", "name": "BRIAN-PC", "ip": ["fe80::c8a4:dc53:fc0e:9397", "169.254.147.151", "fe80::a5c1:e6b:5a23:c20d", "192.168.160.1", "fe80::ccba:d63e:19e:4eed", "169.254.78.237", "fe80::2907:26a0:83d9:94d0", "172.31.57.1", "fe80::74f4:a72c:22bd:a045", "172.18.192.1", "fe80::803c:5a27:a82f:ceea", "192.168.1.218", "fe80::a1b6:f82f:32e8:cdca", "169.254.205.202", "fe80::602f:fe9a:a624:2328", "169.254.35.40", "fe80::cd9f:2a9c:6f46:8af3", "169.254.138.243", "fe80::c424:5ee5:7b11:4548", "192.168.80.1", "fe80::9c91:3f61:a309:4de8", "172.22.224.1", "fe80::d0aa:5052:4321:2df8", "172.26.176.1", "fe80::584f:1936:b572:690c", "172.23.0.1", "fe80::cba:c4ed:4599:2f99", "172.27.96.1"], "mac": ["00:ff:a3:9b:ea:65", "00:15:5d:76:5c:5d", "00:15:5d:38:01:02", "00:15:5d:38:01:10", "00:15:5d:f3:b0:43", "38:94:ed:2e:cf:0d", "3a:94:ed:2e:cf:0d", "38:94:ed:2e:cf:0d", "00:ff:54:a4:e6:78", "00:15:5d:33:b9:02", "00:15:5d:eb:e6:65", "00:15:5d:47:24:b7", "00:15:5d:78:6f:9d", "00:15:5d:4e:8b:3f"]}, "network": {"protocol": "dns"}, "process": {"name": "slack.exe", "entity_id": "{f0ea5239-a5c8-617c-9c01-000000006d00}", "pid": 2400, "executable": "C:\\\\Users\\\\Brian\\\\AppData\\\\Local\\\\slack\\\\app-4.20.0\\\\slack.exe"}, "dns": {"question": {"name": "netwars-support.slack.com", "registered_domain": "slack.com", "top_level_domain": "com", "subdomain": "netwars-support"}, "answers": [{"type": "A", "data": "34.204.109.226"}, {"type": "A", "data": "3.95.117.96"}, {"type": "A", "data": "34.203.97.10"}, {"type": "A", "data": "54.163.235.119"}, {"type": "A", "data": "54.147.59.169"}, {"type": "A", "data": "34.231.24.224"}, {"type": "A", "data": "34.193.255.5"}, {"type": "A", "data": "34.225.62.185"}, {"type": "A", "data": "54.92.199.186"}], "resolved_ip": ["34.204.109.226", "3.95.117.96", "34.203.97.10", "54.163.235.119", "54.147.59.169", "34.231.24.224", "34.193.255.5", "34.225.62.185", "54.92.199.186"]}, "winlog": {"event_id": "22", "task": "Dns query (rule: DnsQuery)", "api": "wineventlog", "process": {"pid": 5204, "thread": {"id": 6328}}, "user": {"identifier": "S-1-5-18", "domain": "NT AUTHORITY", "name": "SYSTEM", "type": "User"}, "provider_guid": "{5770385f-c22a-43e0-bf4c-06f5698ffbd9}", "provider_name": "Microsoft-Windows-Sysmon", "version": 5, "channel": "Microsoft-Windows-Sysmon/Operational", "computer_name": "BRIAN-PC", "event_data": {"User": "BRIAN-PC\\\\Brian"}, "record_id": 74802438, "opcode": "Info"}, "event": {"created": "2021-11-06T05:08:06.954Z", "code": "22", "kind": "signal", "provider": "Microsoft-Windows-Sysmon", "action": "Dns query (rule: DnsQuery)", "module": "sysmon", "category": ["network"], "type": ["connection", "protocol", "info"]}, "ecs": {"version": "1.11.0"}, "agent": {"version": "7.15.1", "hostname": "BRIAN-PC", "ephemeral_id": "da12c65a-b701-483f-b656-fbe25c884380", "id": "21aa23a8-6f3f-4365-b3ce-55855b75dd51", "name": "BRIAN-PC", "type": "winlogbeat"}, "signal": {"_meta": {"version": 45}, "parents": [{"id": "QpKl83wBZ5pJo3SvcNpe", "type": "event", "index": "winlogbeat-7.15.1-2021.10.26-000001", "depth": 0}], "ancestors": [{"id": "QpKl83wBZ5pJo3SvcNpe", "type": "event", "index": "winlogbeat-7.15.1-2021.10.26-000001", "depth": 0}], "status": "open", "rule": {"id": "65417a80-3789-11ec-a7c8-b9d14d243cd3", "actions": [], "interval": "5m", "name": "Suspicious DNS Query", "tags": ["Command & Control"], "enabled": true, "created_by": "elastic", "updated_by": "elastic", "throttle": null, "created_at": "2021-10-28T00:52:59.892Z", "updated_at": "2021-11-06T05:06:11.882Z", "description": "A computer has made a DNS query to a suspicious domain", "risk_score": 21, "severity": "low", "license": "", "output_index": ".siem-signals-default", "meta": {"from": "1m", "kibana_siem_app_url": "https://localhost:5601/app/security"}, "author": [], "false_positives": [], "from": "now-360s", "rule_id": "9ee23221-d63f-410e-9f37-55b6c9d7cc44", "max_signals": 100, "risk_score_mapping": [], "severity_mapping": [], "threat": [], "to": "now", "references": [], "version": 2, "exceptions_list": [], "immutable": false, "type": "query", "language": "kuery", "index": ["winlogbeat-*"], "query": "event.code: 22 AND dns.question.name: (\\"download.sysinternals.com\\" OR \\"netsurge.sh\\" OR \\"reflexsoar.com\\" OR \\"zeroonesecurity.com\\" OR \\"netwars-support.slack.com\\")", "filters": []}, "depth": 1, "parent": {"id": "QpKl83wBZ5pJo3SvcNpe", "type": "event", "index": "winlogbeat-7.15.1-2021.10.26-000001", "depth": 0}, "original_time": "2021-11-06T05:07:54.376Z", "original_event": {"created": "2021-11-06T05:08:06.954Z", "code": "22", "kind": "event", "provider": "Microsoft-Windows-Sysmon", "action": "Dns query (rule: DnsQuery)", "module": "sysmon", "category": ["network"], "type": ["connection", "protocol", "info"]}}}', 'signature': '3bf7a4806f620e91ec40039056bdea4c', 'dismiss_reason': None, 'dismiss_comment': None},
      {'raw_log': "{'log': {'level':'information'}}"},
      #{'title': 'blah', 'command': 'powershell -encodedCommand SW52b2tlLVdlYlJlcXVlc3QgaHR0cHM6Ly93d3cucmVmbGV4c29hci5jb20= -encodedCommand SW52b2tlLVdlYlJlcXVlc3QgaHR0cHM6Ly93d3cucmVmbGV4c29hci5jb20='}
    ]

    qp = QueryParser()

    while True:
        s = input('[Yacc Mode] Query: ')
        if not s:
            break
        if s == 'exit':
            exit()
        try:
            result = qp.parser.parse(s)
        except LexError as e:
            print(e)
            result = None
        if not result:
            continue
        print(result)
        for event in qp.run_search(db, result):
            print(event)
        print()